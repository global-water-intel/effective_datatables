<%
  html_id = "#{datatable.to_param}-table-#{Time.zone.now.nsec}"
  effective_datatable_params = {
    id: html_id,
    class: "effective-datatable #{datatable.table_html_class}",
    data: {
      'effective-form-inputs' => defined?(EffectiveFormInputs),
      'bulk-actions' => datatable_bulk_actions(datatable),
      'columns' => datatable_columns(datatable),
      'input-js-options' => local_assigns[:input_js_options],
      'simple' => datatable.simple?.to_s,
      'reset-filter-buttons' => datatable.reset_filter_buttons?.to_s,
      'source' => effective_datatables.datatable_path(datatable, {format: 'json'}.merge(attributes: datatable.attributes)).chomp('?'),
      'default-order' => datatable_default_order(datatable),
      'display-entries' => datatable.display_entries,
      'display-records' => (datatable.to_json[:recordsFiltered] || 0),
      'total-records' => (datatable.to_json[:recordsTotal] || 0),
      'display-start' => datatable.display_start,
      'page-length' => datatable.per_page
    }
  }
%>

<%= render_datatable_scopes(datatable) %>

<% if datatable.charts? %>
  <div class="<%= html_id %> charts-container">
    <%= render partial: datatable.charts_partial, locals: { datatable: datatable } %>
  </div>
<% end %>

<%= content_tag 'table', effective_datatable_params do %>
  <thead>
    <tr>
      <% datatable.display_or_default_table_columns.each do |name, opts| %>
        <th><%= opts[:label] || name %></th>
      <% end %>
    </tr>
  </thead>
  <tbody>
    <% datatable.to_json[:data].each do |row| %>
      <tr>
        <% row.each do |col| %>
          <td>
            <%= col.to_s.html_safe %>
          </td>
        <% end %>
      </tr>
    <% end %>
  </tbody>

  <% if datatable.aggregates.present? %>
    <tfoot>
      <% datatable.to_json[:aggregates].each do |row| %>
        <tr>
          <% row.each do |col| %>
            <td><%= col.to_s.html_safe %></td>
          <% end %>
        </tr>
      <% end %>
    </tfoot>
  <% end %>
<% end %>
